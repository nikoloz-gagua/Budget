<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0D0D0E">
<title>vault.</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Karla:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0D0D0E;
  --surface: #141416;
  --elevated: #1C1C20;
  --elevated2: #222228;
  --border: #2A2A32;
  --accent: #C8A96E;
  --accent-dim: rgba(200,169,110,0.12);
  --accent-glow: rgba(200,169,110,0.25);
  --blue: #5B9CF6;
  --blue-dim: rgba(91,156,246,0.12);
  --red: #E05C5C;
  --red-dim: rgba(224,92,92,0.12);
  --green: #6BBF7F;
  --green-dim: rgba(107,191,127,0.12);
  --purple: #9B7FE8;
  --purple-dim: rgba(155,127,232,0.12);
  --text: #F0EEE9;
  --text-muted: #7A7875;
  --text-dim: #3E3E48;
  --r: 14px;
  --r-sm: 9px;
  --mono: 'JetBrains Mono', monospace;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { height: 100%; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Karla', sans-serif;
  font-size: 15px;
  height: 100%;
  overflow-x: hidden;
  -webkit-tap-highlight-color: transparent;
}

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app {
  max-width: 480px;
  margin: 0 auto;
  min-height: 100%;
  position: relative;
}

.app-header {
  position: sticky;
  top: 0;
  z-index: 200;
  background: rgba(13,13,14,0.92);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  padding: 13px 18px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.app-logo {
  font-family: 'Playfair Display', serif;
  font-size: 22px;
  font-weight: 700;
  color: var(--accent);
  letter-spacing: -0.5px;
  user-select: none;
}

.app-logo span { opacity: 0.4; }

.month-nav {
  display: flex;
  align-items: center;
  gap: 6px;
}

.month-btn {
  background: var(--elevated);
  border: 1px solid var(--border);
  color: var(--text);
  width: 30px;
  height: 30px;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  line-height: 1;
  transition: background 0.15s;
  flex-shrink: 0;
}
.month-btn:active { background: var(--elevated2); }

#monthLabel {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text);
  min-width: 72px;
  text-align: center;
  letter-spacing: 0.3px;
}

/* â”€â”€ Bottom Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 480px;
  background: rgba(20,20,22,0.96);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-top: 1px solid var(--border);
  display: flex;
  z-index: 200;
  padding-bottom: env(safe-area-inset-bottom, 0px);
}

.nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  padding: 9px 0 10px;
  cursor: pointer;
  color: var(--text-dim);
  font-size: 9px;
  font-weight: 600;
  letter-spacing: 0.4px;
  text-transform: uppercase;
  transition: color 0.2s;
  border: none;
  background: none;
  position: relative;
}
.nav-item.active { color: var(--accent); }
.nav-item svg { width: 19px; height: 19px; stroke-width: 1.75; }
.nav-dot {
  position: absolute;
  top: 7px;
  right: calc(50% - 14px);
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--red);
  display: none;
}
.nav-item.has-alert .nav-dot { display: block; }

/* â”€â”€ Pages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page {
  display: none;
  padding: 14px 14px 100px;
  animation: fadeIn 0.2s ease;
}
.page.active { display: block; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

/* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 15px;
  margin-bottom: 11px;
}

.card-label {
  font-size: 10px;
  font-weight: 700;
  color: var(--text-muted);
  letter-spacing: 0.8px;
  text-transform: uppercase;
  margin-bottom: 11px;
}

/* â”€â”€ Summary Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.summary-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 9px;
  margin-bottom: 11px;
}
.s-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 13px 12px;
  position: relative;
  overflow: hidden;
}
.s-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: var(--border);
  border-radius: 2px 2px 0 0;
}
.s-card.c-green::before { background: var(--green); }
.s-card.c-red::before { background: var(--red); }
.s-card.c-accent::before { background: var(--accent); }
.s-card.c-blue::before { background: var(--blue); }
.s-label {
  font-size: 10px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
  margin-bottom: 5px;
}
.s-value {
  font-family: var(--mono);
  font-size: 19px;
  font-weight: 500;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.s-value.green { color: var(--green); }
.s-value.red { color: var(--red); }
.s-value.accent { color: var(--accent); }
.s-value.blue { color: var(--blue); }
.s-sub { font-size: 11px; color: var(--text-muted); margin-top: 3px; }

/* â”€â”€ Section Title â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page-title {
  font-family: 'Playfair Display', serif;
  font-size: 20px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 14px;
}

/* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  padding: 10px 15px;
  border-radius: var(--r-sm);
  border: none;
  cursor: pointer;
  font-family: 'Karla', sans-serif;
  font-size: 14px;
  font-weight: 600;
  transition: opacity 0.15s, transform 0.1s;
  white-space: nowrap;
}
.btn:active { transform: scale(0.97); opacity: 0.8; }
.btn-primary { background: var(--accent); color: #0D0D0E; }
.btn-secondary { background: var(--elevated); color: var(--text); border: 1px solid var(--border); }
.btn-danger { background: var(--red-dim); color: var(--red); border: 1px solid rgba(224,92,92,0.25); }
.btn-ghost { background: transparent; color: var(--text-muted); padding: 7px 9px; }
.btn-success { background: var(--green-dim); color: var(--green); border: 1px solid rgba(107,191,127,0.25); }
.btn-sm { padding: 7px 11px; font-size: 13px; }
.btn-xs { padding: 5px 8px; font-size: 12px; }
.btn-full { width: 100%; }

/* â”€â”€ Action row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.action-row {
  display: flex;
  gap: 7px;
  margin-bottom: 11px;
  flex-wrap: wrap;
}
.action-row .btn { flex: 1; min-width: 80px; }

/* â”€â”€ Alerts / Insights â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.alert {
  padding: 11px 13px;
  border-radius: var(--r-sm);
  font-size: 13px;
  margin-bottom: 7px;
  display: flex;
  gap: 9px;
  align-items: flex-start;
  line-height: 1.4;
}
.alert-icon { flex-shrink: 0; font-size: 14px; margin-top: 1px; }
.alert.danger { background: var(--red-dim); border: 1px solid rgba(224,92,92,0.2); color: var(--red); }
.alert.warning { background: var(--accent-dim); border: 1px solid rgba(200,169,110,0.2); color: var(--accent); }
.alert.info { background: var(--blue-dim); border: 1px solid rgba(91,156,246,0.2); color: var(--blue); }
.alert.success { background: var(--green-dim); border: 1px solid rgba(107,191,127,0.2); color: var(--green); }
.alert.purple { background: var(--purple-dim); border: 1px solid rgba(155,127,232,0.2); color: var(--purple); }

/* â”€â”€ Forms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-group { margin-bottom: 13px; }
.form-label {
  display: block;
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.6px;
  font-weight: 600;
  margin-bottom: 6px;
}
.form-input, .form-select {
  width: 100%;
  background: var(--elevated);
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: var(--r-sm);
  padding: 11px 12px;
  font-family: 'Karla', sans-serif;
  font-size: 15px;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
  appearance: none;
  -webkit-appearance: none;
}
.form-input:focus, .form-select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-dim);
}
.form-select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%237A7875' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 34px; }
.form-select option { background: #1C1C20; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

/* â”€â”€ Toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toggle-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 11px 0;
  border-bottom: 1px solid var(--border);
}
.toggle-row:last-of-type { border-bottom: none; }
.toggle-text { font-size: 14px; color: var(--text); }
.toggle-sub { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
.toggle {
  position: relative;
  width: 42px;
  height: 23px;
  flex-shrink: 0;
}
.toggle input { display: none; }
.toggle-track {
  position: absolute;
  inset: 0;
  background: var(--border);
  border-radius: 12px;
  cursor: pointer;
  transition: background 0.2s;
}
.toggle-track::before {
  content: '';
  position: absolute;
  left: 3px; top: 3px;
  width: 17px; height: 17px;
  background: var(--text-muted);
  border-radius: 50%;
  transition: transform 0.2s, background 0.2s;
}
.toggle input:checked ~ .toggle-track { background: var(--accent-dim); border: 1px solid var(--accent-glow); }
.toggle input:checked ~ .toggle-track::before { transform: translateX(19px); background: var(--accent); }

/* â”€â”€ List Items â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.list-item {
  display: flex;
  align-items: center;
  padding: 11px 0;
  border-bottom: 1px solid var(--border);
  gap: 10px;
}
.list-item:last-child { border-bottom: none; }
.li-icon {
  width: 34px;
  height: 34px;
  border-radius: 9px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 15px;
}
.li-main { flex: 1; min-width: 0; }
.li-title { font-size: 14px; font-weight: 500; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.li-sub { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
.li-amount { font-family: var(--mono); font-size: 14px; font-weight: 500; flex-shrink: 0; }
.li-actions { display: flex; gap: 2px; flex-shrink: 0; }

/* â”€â”€ Progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.progress-bar { height: 5px; background: var(--elevated2); border-radius: 3px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }

/* â”€â”€ Tags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tag {
  display: inline-flex;
  align-items: center;
  padding: 2px 7px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  white-space: nowrap;
}
.tag-fixed { background: var(--blue-dim); color: var(--blue); }
.tag-variable { background: var(--accent-dim); color: var(--accent); }
.tag-sinking { background: var(--green-dim); color: var(--green); }
.tag-must { background: var(--red-dim); color: var(--red); }
.tag-should { background: var(--accent-dim); color: var(--accent); }
.tag-nice { background: var(--green-dim); color: var(--green); }
.tag-rollover { background: var(--purple-dim); color: var(--purple); }

/* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tabs {
  display: flex;
  background: var(--elevated);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 3px;
  gap: 3px;
  margin-bottom: 13px;
}
.tab-btn {
  flex: 1;
  padding: 8px;
  border-radius: 6px;
  border: none;
  background: transparent;
  color: var(--text-muted);
  font-family: 'Karla', sans-serif;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.18s;
  white-space: nowrap;
}
.tab-btn.active {
  background: var(--elevated2);
  color: var(--text);
  box-shadow: 0 1px 4px rgba(0,0,0,0.35);
}

/* â”€â”€ Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.search-wrap {
  position: relative;
  margin-bottom: 11px;
}
.search-wrap input {
  width: 100%;
  background: var(--elevated);
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: var(--r-sm);
  padding: 10px 12px 10px 36px;
  font-family: 'Karla', sans-serif;
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s;
}
.search-wrap input:focus { border-color: var(--accent); }
.search-icon {
  position: absolute;
  left: 11px; top: 50%;
  transform: translateY(-50%);
  color: var(--text-dim);
  font-size: 14px;
  pointer-events: none;
}

/* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.65);
  z-index: 500;
  align-items: flex-end;
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--surface);
  border: 1px solid var(--border);
  border-top: 1px solid rgba(255,255,255,0.06);
  border-radius: 20px 20px 0 0;
  padding: 0 18px 36px;
  width: 100%;
  max-width: 480px;
  margin: 0 auto;
  max-height: 92vh;
  overflow-y: auto;
  animation: slideUp 0.25s cubic-bezier(0.34,1.26,0.64,1);
}
@keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.modal-handle {
  width: 36px; height: 4px;
  background: var(--border);
  border-radius: 2px;
  margin: 14px auto 18px;
}
.modal-title {
  font-family: 'Playfair Display', serif;
  font-size: 20px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 18px;
}

/* â”€â”€ FAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.fab {
  position: fixed;
  bottom: 74px;
  right: max(16px, calc(50% - 226px));
  width: 48px; height: 48px;
  border-radius: 50%;
  background: var(--accent);
  color: #0D0D0E;
  border: none;
  cursor: pointer;
  font-size: 22px;
  font-weight: 300;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 6px 24px rgba(200,169,110,0.45), 0 2px 8px rgba(0,0,0,0.4);
  z-index: 150;
  transition: transform 0.2s, box-shadow 0.2s;
}
.fab:active { transform: scale(0.9); box-shadow: 0 3px 12px rgba(200,169,110,0.3); }

/* â”€â”€ Category Health â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cat-row {
  padding: 11px 0;
  border-bottom: 1px solid var(--border);
}
.cat-row:last-child { border-bottom: none; }
.cat-row-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 5px;
}
.cat-name { font-size: 13px; font-weight: 500; color: var(--text); }
.cat-amounts { font-family: var(--mono); font-size: 12px; color: var(--text-muted); }
.cat-row-bot { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); margin-top: 4px; }

/* â”€â”€ Empty State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty {
  text-align: center;
  padding: 36px 20px;
  color: var(--text-muted);
}
.empty-emoji { font-size: 38px; margin-bottom: 10px; opacity: 0.4; }
.empty-title { font-family: 'Playfair Display', serif; font-size: 16px; color: var(--text-dim); margin-bottom: 5px; }
.empty-sub { font-size: 13px; }

/* â”€â”€ Divider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.divider { height: 1px; background: var(--border); margin: 13px 0; }

/* â”€â”€ Closed badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.closed-badge {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 4px 10px; border-radius: 20px;
  background: var(--green-dim);
  border: 1px solid rgba(107,191,127,0.3);
  color: var(--green);
  font-size: 10px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.5px;
}

/* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width: 3px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* â”€â”€ Inline number input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.num-input {
  width: 90px;
  background: var(--elevated2);
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: 7px;
  padding: 7px 9px;
  font-family: var(--mono);
  font-size: 13px;
  outline: none;
  text-align: right;
}
.num-input:focus { border-color: var(--accent); }

/* â”€â”€ Goal card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.goal-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 15px;
  margin-bottom: 10px;
  position: relative;
  overflow: hidden;
}
.goal-card::after {
  content: '';
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, var(--accent), var(--green));
  opacity: 0;
  transition: opacity 0.3s;
}
.goal-card.complete::after { opacity: 1; }

/* â”€â”€ Template card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tmpl-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 14px;
  margin-bottom: 9px;
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 10px;
}

/* â”€â”€ Plan summary rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.plan-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 7px 0;
  border-bottom: 1px solid var(--border);
}
.plan-row:last-child { border-bottom: none; padding-top: 9px; }
.plan-row-label { font-size: 13px; color: var(--text-muted); }
.plan-row-val { font-family: var(--mono); font-size: 14px; font-weight: 500; }

/* â”€â”€ Date group header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.date-group-header {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 8px 2px 4px;
}

/* â”€â”€ Canvas chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#cashflowChart { display: block; }

</style>
</head>
<body>
<div id="app">

  <!-- â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <header class="app-header">
    <span class="app-logo">vault<span>.</span></span>
    <div class="month-nav">
      <button class="month-btn" id="prevMonth">â€¹</button>
      <span id="monthLabel"></span>
      <button class="month-btn" id="nextMonth">â€º</button>
    </div>
  </header>

  <!-- â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section class="page active" id="page-dashboard">
    <div id="closedBadge" style="margin-bottom:10px"></div>
    <div class="summary-grid" id="summaryGrid"></div>

    <div class="card">
      <div class="card-label">6-Month Cashflow</div>
      <canvas id="cashflowChart" height="150"></canvas>
      <div style="display:flex;gap:16px;margin-top:10px">
        <div style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text-muted)">
          <span style="width:10px;height:10px;border-radius:2px;background:rgba(107,191,127,0.7);display:inline-block"></span>Income
        </div>
        <div style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text-muted)">
          <span style="width:10px;height:10px;border-radius:2px;background:rgba(224,92,92,0.7);display:inline-block"></span>Expenses
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-label">Category Health</div>
      <div id="catHealth"></div>
    </div>

    <div class="card" id="alertsCard">
      <div class="card-label">Insights & Alerts</div>
      <div id="alertsList"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:11px">
        <span class="card-label" style="margin:0">Recent Transactions</span>
        <button class="btn btn-ghost btn-xs" onclick="goTo('transactions')">See all â†’</button>
      </div>
      <div id="recentTxns"></div>
    </div>
  </section>

  <!-- â•â• BUDGET PLANNER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section class="page" id="page-budget">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:13px">
      <h2 class="page-title" style="margin:0">Budget Plan</h2>
      <div id="budgetClosedBadge"></div>
    </div>

    <div class="action-row">
      <button class="btn btn-secondary btn-sm" onclick="copyPreviousMonth()">âŸµ Copy Prev</button>
      <button class="btn btn-secondary btn-sm" onclick="applyTemplates()">âŠ Apply Templates</button>
      <button class="btn btn-secondary btn-sm" onclick="showCloseModal()">âœ“ Close Month</button>
    </div>

    <!-- Income Section -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:11px">
        <span class="card-label" style="margin:0">Income Sources</span>
        <button class="btn btn-primary btn-sm" onclick="openIncomeModal()">+ Add</button>
      </div>
      <div id="incomeList"></div>
      <div class="divider" style="margin:10px 0 8px"></div>
      <div style="display:flex;justify-content:space-between">
        <span style="font-size:13px;color:var(--text-muted)">Total Planned</span>
        <span class="li-amount" id="totalPlannedIncome" style="color:var(--green)">â‚¬0.00</span>
      </div>
    </div>

    <!-- Categories -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:11px">
        <span class="card-label" style="margin:0">Expense Categories</span>
        <button class="btn btn-primary btn-sm" onclick="openCatModal()">+ Add</button>
      </div>
      <div id="catList"></div>
      <div class="divider" style="margin:10px 0 8px"></div>
      <div style="display:flex;justify-content:space-between">
        <span style="font-size:13px;color:var(--text-muted)">Total Allocated</span>
        <span class="li-amount" id="totalAllocated">â‚¬0.00</span>
      </div>
    </div>

    <!-- Savings Contributions -->
    <div class="card">
      <div class="card-label">Savings Contributions</div>
      <div id="savingsContribList"></div>
    </div>

    <!-- Buffer & Summary -->
    <div class="card">
      <div class="card-label">Plan Summary</div>
      <div id="planSummary"></div>
      <div class="divider"></div>
      <div class="form-group" style="margin-bottom:8px">
        <label class="form-label">Buffer / Emergency Reserve (â‚¬)</label>
        <input type="number" class="form-input" id="bufferInput" placeholder="0.00" oninput="saveBuffer()">
      </div>
      <button class="btn btn-secondary btn-full btn-sm" onclick="autoBalance()">âŸ³ Auto-Balance Remaining â†’ Buffer</button>
    </div>
  </section>

  <!-- â•â• TRANSACTIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section class="page" id="page-transactions">
    <div class="tabs">
      <button class="tab-btn active" onclick="setTxnFilter('all',this)">All</button>
      <button class="tab-btn" onclick="setTxnFilter('income',this)">Income</button>
      <button class="tab-btn" onclick="setTxnFilter('expense',this)">Expense</button>
    </div>
    <div class="search-wrap">
      <span class="search-icon">ğŸ”</span>
      <input type="text" id="txnSearch" placeholder="Search by description, category, noteâ€¦" oninput="renderTransactions()">
    </div>
    <div id="txnList"></div>
  </section>

  <!-- â•â• TEMPLATES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section class="page" id="page-templates">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:13px">
      <h2 class="page-title" style="margin:0">Templates</h2>
      <span style="font-size:12px;color:var(--text-muted)">Reusable categories</span>
    </div>
    <div id="templateList"></div>
  </section>

  <!-- â•â• SAVINGS GOALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section class="page" id="page-goals">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:13px">
      <h2 class="page-title" style="margin:0">Savings Goals</h2>
    </div>
    <div id="goalList"></div>
  </section>

  <!-- â•â• BOTTOM NAV â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <nav class="bottom-nav">
    <button class="nav-item active" id="nav-dashboard" onclick="goTo('dashboard')">
      <div class="nav-dot"></div>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg>
      Dash
    </button>
    <button class="nav-item" id="nav-budget" onclick="goTo('budget')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/><path d="M7 15h2M15 15h2"/></svg>
      Budget
    </button>
    <button class="nav-item" id="nav-transactions" onclick="goTo('transactions')">
      <div class="nav-dot" id="txnAlertDot"></div>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg>
      Txns
    </button>
    <button class="nav-item" id="nav-templates" onclick="goTo('templates')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="18" height="5" rx="1.5"/><rect x="3" y="11" width="11" height="5" rx="1.5"/><rect x="3" y="19" width="7" height="2" rx="1"/></svg>
      Templates
    </button>
    <button class="nav-item" id="nav-goals" onclick="goTo('goals')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="9"/><circle cx="12" cy="12" r="5"/><circle cx="12" cy="12" r="1.5" fill="currentColor"/></svg>
      Goals
    </button>
  </nav>

  <!-- FAB -->
  <button class="fab" id="fab" onclick="handleFab()">+</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Income Modal -->
<div class="modal-overlay" id="m-income">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="incomeMTitle">Add Income</div>
    <div class="form-group">
      <label class="form-label">Label</label>
      <input type="text" class="form-input" id="i-label" placeholder="e.g. Salary, Freelance">
    </div>
    <div class="form-group">
      <label class="form-label">Planned Amount (â‚¬)</label>
      <input type="number" class="form-input" id="i-amount" placeholder="0.00" step="0.01">
    </div>
    <input type="hidden" id="i-id">
    <div style="display:flex;gap:8px">
      <button class="btn btn-secondary" style="flex:1" onclick="closeModal('m-income')">Cancel</button>
      <button class="btn btn-primary" style="flex:1" onclick="saveIncome()">Save</button>
    </div>
  </div>
</div>

<!-- Category Modal -->
<div class="modal-overlay" id="m-cat">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="catMTitle">Add Category</div>
    <div class="form-group">
      <label class="form-label">Category Name</label>
      <input type="text" class="form-input" id="c-name" placeholder="e.g. Groceries, Rent">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Type</label>
        <select class="form-select" id="c-type">
          <option value="fixed">Fixed</option>
          <option value="variable" selected>Variable</option>
          <option value="sinking">Sinking</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Priority</label>
        <select class="form-select" id="c-priority">
          <option value="must">Must</option>
          <option value="should" selected>Should</option>
          <option value="nice">Nice</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Planned Amount (â‚¬)</label>
      <input type="number" class="form-input" id="c-planned" placeholder="0.00" step="0.01">
    </div>
    <div class="form-group">
      <label class="form-label">Carry-In / Rollover from prev. month (â‚¬)</label>
      <input type="number" class="form-input" id="c-carryin" placeholder="0.00" step="0.01">
    </div>
    <div class="toggle-row">
      <div>
        <div class="toggle-text">Enable Rollover</div>
        <div class="toggle-sub">Leftover carries to next month on close</div>
      </div>
      <label class="toggle">
        <input type="checkbox" id="c-rollover">
        <span class="toggle-track"></span>
      </label>
    </div>
    <br>
    <input type="hidden" id="c-id">
    <div style="display:flex;gap:8px">
      <button class="btn btn-secondary" style="flex:1" onclick="closeModal('m-cat')">Cancel</button>
      <button class="btn btn-primary" style="flex:1" onclick="saveCat()">Save</button>
    </div>
  </div>
</div>

<!-- Transaction Modal -->
<div class="modal-overlay" id="m-txn">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="txnMTitle">Add Transaction</div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Type</label>
        <select class="form-select" id="t-type">
          <option value="expense">Expense</option>
          <option value="income">Income</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Date</label>
        <input type="date" class="form-input" id="t-date">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Description</label>
      <input type="text" class="form-input" id="t-desc" placeholder="e.g. Tesco, Spotify">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Amount (â‚¬)</label>
        <input type="number" class="form-input" id="t-amount" placeholder="0.00" step="0.01">
      </div>
      <div class="form-group">
        <label class="form-label">Category</label>
        <select class="form-select" id="t-cat"></select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Note (optional)</label>
      <input type="text" class="form-input" id="t-note" placeholder="Any extra infoâ€¦">
    </div>
    <input type="hidden" id="t-id">
    <div style="display:flex;gap:8px">
      <button class="btn btn-secondary" style="flex:1" onclick="closeModal('m-txn')">Cancel</button>
      <button class="btn btn-primary" style="flex:1" onclick="saveTxn()">Save</button>
    </div>
  </div>
</div>

<!-- Template Modal -->
<div class="modal-overlay" id="m-tmpl">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="tmplMTitle">Add Template</div>
    <div class="form-group">
      <label class="form-label">Name</label>
      <input type="text" class="form-input" id="tm-name" placeholder="e.g. Groceries">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Type</label>
        <select class="form-select" id="tm-type">
          <option value="fixed">Fixed</option>
          <option value="variable" selected>Variable</option>
          <option value="sinking">Sinking</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Priority</label>
        <select class="form-select" id="tm-priority">
          <option value="must">Must</option>
          <option value="should" selected>Should</option>
          <option value="nice">Nice</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Default Monthly Amount (â‚¬)</label>
      <input type="number" class="form-input" id="tm-amount" placeholder="0.00" step="0.01">
    </div>
    <div class="toggle-row">
      <div>
        <div class="toggle-text">Enable Rollover by default</div>
      </div>
      <label class="toggle">
        <input type="checkbox" id="tm-rollover">
        <span class="toggle-track"></span>
      </label>
    </div>
    <br>
    <input type="hidden" id="tm-id">
    <div style="display:flex;gap:8px">
      <button class="btn btn-secondary" style="flex:1" onclick="closeModal('m-tmpl')">Cancel</button>
      <button class="btn btn-primary" style="flex:1" onclick="saveTmpl()">Save</button>
    </div>
  </div>
</div>

<!-- Goal Modal -->
<div class="modal-overlay" id="m-goal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="goalMTitle">Add Goal</div>
    <div class="form-group">
      <label class="form-label">Goal Name</label>
      <input type="text" class="form-input" id="g-name" placeholder="e.g. Emergency Fund, Holiday">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Target (â‚¬)</label>
        <input type="number" class="form-input" id="g-target" placeholder="0.00" step="0.01">
      </div>
      <div class="form-group">
        <label class="form-label">Already Saved (â‚¬)</label>
        <input type="number" class="form-input" id="g-saved" placeholder="0.00" step="0.01">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Target Deadline (optional)</label>
      <input type="month" class="form-input" id="g-deadline">
    </div>
    <input type="hidden" id="g-id">
    <div style="display:flex;gap:8px">
      <button class="btn btn-secondary" style="flex:1" onclick="closeModal('m-goal')">Cancel</button>
      <button class="btn btn-primary" style="flex:1" onclick="saveGoal()">Save</button>
    </div>
  </div>
</div>

<!-- Close Month Modal -->
<div class="modal-overlay" id="m-close">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Close Month</div>
    <div class="alert info" style="margin-bottom:14px">
      <span class="alert-icon">â„¹ï¸</span>
      <span>Leftover balances from rollover-enabled categories will carry forward to next month as carry-in.</span>
    </div>
    <div id="rolloverPreview"></div>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button class="btn btn-secondary" style="flex:1" onclick="closeModal('m-close')">Cancel</button>
      <button class="btn btn-primary" style="flex:1" onclick="closeMonth()">Close &amp; Roll Forward</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE & STORAGE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SK = {
  months:       'v_months',
  transactions: 'v_txns',
  templates:    'v_templates',
  goals:        'v_goals',
  activeMonth:  'v_month'
};

let S = {
  months:       {},
  transactions: [],
  templates:    [],
  goals:        [],
  activeMonth:  ''
};

let txnFilter = 'all';
let currentPage = 'dashboard';

function loadState() {
  const now = new Date();
  const def = ymd(now.getFullYear(), now.getMonth()+1);
  S.months       = JSON.parse(ls(SK.months)       || '{}');
  S.transactions = JSON.parse(ls(SK.transactions) || '[]');
  S.templates    = JSON.parse(ls(SK.templates)    || '[]');
  S.goals        = JSON.parse(ls(SK.goals)        || '[]');
  S.activeMonth  = ls(SK.activeMonth) || def;
}

function saveState() {
  set(SK.months,       JSON.stringify(S.months));
  set(SK.transactions, JSON.stringify(S.transactions));
  set(SK.templates,    JSON.stringify(S.templates));
  set(SK.goals,        JSON.stringify(S.goals));
  set(SK.activeMonth,  S.activeMonth);
}

function ls(k)      { return localStorage.getItem(k); }
function set(k, v)  { localStorage.setItem(k, v); }
function uid()      { return Math.random().toString(36).substr(2,10); }
function ymd(y, m)  { return `${y}-${String(m).padStart(2,'0')}`; }

function getPlan(m) {
  if (!S.months[m]) {
    S.months[m] = { incomes:[], categories:[], buffer:0, savingsContributions:{}, closed:false };
  }
  return S.months[m];
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// COMPUTED
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function monthTxns(m)          { return S.transactions.filter(t => t.month === m); }
function actualIncome(m)       { return monthTxns(m).filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0); }
function actualExpenses(m)     { return monthTxns(m).filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0); }
function plannedIncome(m)      { return getPlan(m).incomes.reduce((s,i)=>s+i.planned,0); }
function totalAllocated(m)     { return getPlan(m).categories.reduce((s,c)=>s+c.planned,0); }
function totalSavingsContrib(m){ return Object.values(getPlan(m).savingsContributions).reduce((s,v)=>s+v,0); }
function unallocated(m)        { const p=getPlan(m); return plannedIncome(m) - totalAllocated(m) - totalSavingsContrib(m) - (p.buffer||0); }

function catActual(m, name)    { return monthTxns(m).filter(t=>t.type==='expense'&&t.category===name).reduce((s,t)=>s+t.amount,0); }

function catForecast(m, name) {
  const [y,mo] = m.split('-').map(Number);
  const dim = new Date(y,mo,0).getDate();
  const now = new Date();
  const today = (now.getFullYear()===y && now.getMonth()+1===mo) ? now.getDate() : dim;
  const actual = catActual(m, name);
  return today>0 ? (actual/today)*dim : actual;
}

function dailyAllowance(m) {
  const [y,mo] = m.split('-').map(Number);
  const dim = new Date(y,mo,0).getDate();
  const now = new Date();
  const today = (now.getFullYear()===y && now.getMonth()+1===mo) ? now.getDate() : dim;
  const remaining = dim - today;
  if (remaining <= 0) return 0;
  const plan = getPlan(m);
  const varCats = plan.categories.filter(c=>c.type!=='fixed');
  const vBudget = varCats.reduce((s,c)=>s+(c.planned+(c.carryIn||0)),0);
  const vSpent  = varCats.reduce((s,c)=>s+catActual(m,c.name),0);
  return Math.max(0, (vBudget - vSpent) / remaining);
}

function projectedSpend(m) {
  const [y,mo] = m.split('-').map(Number);
  const dim = new Date(y,mo,0).getDate();
  const now = new Date();
  const today = (now.getFullYear()===y && now.getMonth()+1===mo) ? now.getDate() : dim;
  const exp = actualExpenses(m);
  return today>0 ? (exp/today)*dim : exp;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FORMAT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n, full=false) {
  const abs = Math.abs(n);
  const s = full ? abs.toFixed(2) : (abs>=1000 ? (abs/1000).toFixed(1)+'k' : abs.toFixed(2));
  return (n<0?'-':'')+'â‚¬'+s;
}
const fmtF = n => fmt(n, true);

function monthName(m) {
  const [y,mo] = m.split('-').map(Number);
  return ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][mo-1]+' '+y;
}

function catEmoji(cat) {
  if (!cat) return 'ğŸ’³';
  const l = cat.toLowerCase();
  const map = [
    ['groceries','ğŸ›’'],['food','ğŸ”'],['dining','ğŸ½'],['restaurant','ğŸ½'],['coffee','â˜•'],
    ['transport','ğŸšŒ'],['fuel','â›½'],['petrol','â›½'],['rent','ğŸ '],['housing','ğŸ '],
    ['utilities','ğŸ’¡'],['electric','ğŸ’¡'],['entertainment','ğŸ¬'],['cinema','ğŸ¬'],
    ['health','ğŸ’Š'],['pharmacy','ğŸ’Š'],['fitness','ğŸ‹'],['gym','ğŸ‹'],
    ['clothing','ğŸ‘•'],['shopping','ğŸ›'],['subscriptions','ğŸ“±'],['netflix','ğŸ“º'],
    ['travel','âœˆï¸'],['education','ğŸ“š'],['savings','ğŸ’°'],['insurance','ğŸ›¡'],
    ['takeaway','ğŸ¥¡'],['bar','ğŸº'],['alcohol','ğŸº']
  ];
  for (const [k,v] of map) if (l.includes(k)) return v;
  return 'ğŸ’³';
}

function progressColor(pct) {
  if (pct >= 100) return 'var(--red)';
  if (pct >= 85)  return 'var(--accent)';
  return 'var(--green)';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// NAVIGATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goTo(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  document.getElementById('nav-'+page).classList.add('active');
  currentPage = page;
  renderPage(page);
  window.scrollTo({top:0,behavior:'smooth'});
}

function renderPage(p) {
  if (p==='dashboard')    renderDashboard();
  else if (p==='budget')  renderBudget();
  else if (p==='transactions') renderTransactions();
  else if (p==='templates')    renderTemplates();
  else if (p==='goals')        renderGoals();
}

function handleFab() {
  if (currentPage==='transactions') openTxnModal();
  else if (currentPage==='templates') openTmplModal();
  else if (currentPage==='goals')     openGoalModal();
  else if (currentPage==='budget')    openCatModal();
  else openTxnModal();
}

// Month navigation
function prevMonth() {
  const [y,m] = S.activeMonth.split('-').map(Number);
  const d = new Date(y,m-2,1);
  S.activeMonth = ymd(d.getFullYear(), d.getMonth()+1);
  saveState(); updateHeader(); renderPage(currentPage);
}
function nextMonth() {
  const [y,m] = S.activeMonth.split('-').map(Number);
  const d = new Date(y,m,1);
  S.activeMonth = ymd(d.getFullYear(), d.getMonth()+1);
  saveState(); updateHeader(); renderPage(currentPage);
}
function updateHeader() { document.getElementById('monthLabel').textContent = monthName(S.activeMonth); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DASHBOARD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDashboard() {
  const m = S.activeMonth;
  const plan = getPlan(m);
  const pInc  = plannedIncome(m);
  const aInc  = actualIncome(m);
  const aExp  = actualExpenses(m);
  const net   = aInc - aExp;
  const proj  = projectedSpend(m);
  const unall = unallocated(m);
  const da    = dailyAllowance(m);

  // Closed badge
  document.getElementById('closedBadge').innerHTML = plan.closed
    ? '<span class="closed-badge">âœ“ Month Closed</span>' : '';

  // Summary grid
  document.getElementById('summaryGrid').innerHTML = `
    <div class="s-card c-blue">
      <div class="s-label">Planned Income</div>
      <div class="s-value blue">${fmt(pInc)}</div>
    </div>
    <div class="s-card ${aInc >= pInc && pInc>0 ? 'c-green':''}">
      <div class="s-label">Actual Income</div>
      <div class="s-value ${aInc>0?'green':''}">${fmt(aInc)}</div>
    </div>
    <div class="s-card ${aExp>0?'c-red':''}">
      <div class="s-label">Actual Expenses</div>
      <div class="s-value ${aExp>0?'red':''}">${fmt(aExp)}</div>
    </div>
    <div class="s-card ${net>=0?'c-green':'c-red'}">
      <div class="s-label">Net Cash</div>
      <div class="s-value ${net>=0?'green':'red'}">${fmt(net)}</div>
    </div>
    <div class="s-card">
      <div class="s-label">Projected Spend</div>
      <div class="s-value">${fmt(proj)}</div>
      <div class="s-sub">by month end</div>
    </div>
    <div class="s-card ${unall<0?'c-red':'c-accent'}">
      <div class="s-label">Unallocated</div>
      <div class="s-value ${unall<0?'red':'accent'}">${fmt(unall)}</div>
    </div>
    ${da > 0 ? `
    <div class="s-card c-green" style="grid-column:span 2">
      <div class="s-label">Safe-to-Spend Daily</div>
      <div class="s-value green">${fmtF(da)} / day</div>
      <div class="s-sub">Variable categories remaining</div>
    </div>` : ''}
  `;

  renderCategoryHealth(m);
  renderAlerts(m);
  renderRecentTxns(m);
  renderCashflowChart();
}

function renderCategoryHealth(m) {
  const plan = getPlan(m);
  const el = document.getElementById('catHealth');
  if (!plan.categories.length) {
    el.innerHTML = '<div class="empty"><div class="empty-emoji">ğŸ“Š</div><div class="empty-title">No categories planned</div></div>';
    return;
  }
  el.innerHTML = plan.categories.map(cat => {
    const actual   = catActual(m, cat.name);
    const budget   = cat.planned + (cat.carryIn||0);
    const remaining= budget - actual;
    const pct      = budget>0 ? Math.min((actual/budget)*100, 100) : 0;
    const forecast = catForecast(m, cat.name);
    const color    = progressColor(pct);
    return `
      <div class="cat-row">
        <div class="cat-row-top">
          <span class="cat-name">${cat.name}</span>
          <span class="cat-amounts" style="color:${pct>=100?'var(--red)':'var(--text-muted)'}">
            ${fmt(actual)} / ${fmt(budget)}
          </span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width:${pct}%;background:${color}"></div>
        </div>
        <div class="cat-row-bot">
          <span>Remaining: <b style="color:${remaining<0?'var(--red)':'var(--text)'}">${fmtF(remaining)}</b></span>
          <span>Forecast: ${fmt(forecast)}</span>
        </div>
      </div>
    `;
  }).join('');
}

function renderAlerts(m) {
  const plan = getPlan(m);
  const pInc = plannedIncome(m);
  const alloc = totalAllocated(m);
  const sav   = totalSavingsContrib(m);
  const buf   = plan.buffer||0;
  const totalOut = alloc + sav + buf;
  const alerts = [];

  if (pInc > 0 && totalOut > pInc)
    alerts.push({ type:'danger', icon:'âš ï¸', msg:`Over-allocated by ${fmtF(totalOut-pInc)} â€” reduce categories or buffer.` });

  const unall = pInc - totalOut;
  if (unall > 50 && pInc > 0)
    alerts.push({ type:'info', icon:'ğŸ’¡', msg:`${fmtF(unall)} is unallocated. Add to a category or buffer.` });

  plan.categories.forEach(cat => {
    const actual = catActual(m, cat.name);
    const budget = cat.planned + (cat.carryIn||0);
    if (actual > budget && budget > 0)
      alerts.push({ type:'danger', icon:'ğŸ”´', msg:`${cat.name}: overspent by ${fmtF(actual-budget)}.` });
    else if (budget > 0 && actual/budget >= 0.85)
      alerts.push({ type:'warning', icon:'ğŸŸ¡', msg:`${cat.name}: ${Math.round(actual/budget*100)}% used â€” getting close.` });
  });

  const expTxns = monthTxns(m).filter(t=>t.type==='expense');
  const planCats = new Set(plan.categories.map(c=>c.name));
  const unplanned = [...new Set(expTxns.map(t=>t.category).filter(c=>c&&!planCats.has(c)))];
  unplanned.forEach(cat =>
    alerts.push({ type:'warning', icon:'â“', msg:`Spending in "${cat}" not in plan.` })
  );

  const da = dailyAllowance(m);
  if (da > 0)
    alerts.push({ type:'success', icon:'âœ…', msg:`You can safely spend ${fmtF(da)}/day on variable expenses.` });

  const proj = projectedSpend(m);
  if (proj > pInc && pInc > 0)
    alerts.push({ type:'danger', icon:'ğŸ“ˆ', msg:`Projected spend (${fmtF(proj)}) exceeds planned income (${fmtF(pInc)}).` });

  const el = document.getElementById('alertsList');
  el.innerHTML = alerts.length
    ? alerts.map(a=>`<div class="alert ${a.type}"><span class="alert-icon">${a.icon}</span><span>${a.msg}</span></div>`).join('')
    : '<div class="alert success"><span class="alert-icon">âœ…</span><span>All looks on track this month.</span></div>';

  // Nav dot
  const hasDanger = alerts.some(a=>a.type==='danger');
  document.getElementById('nav-transactions').classList.toggle('has-alert', hasDanger);
}

function renderRecentTxns(m) {
  const txns = monthTxns(m).sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5);
  const el = document.getElementById('recentTxns');
  if (!txns.length) {
    el.innerHTML = '<div class="empty"><div class="empty-emoji">ğŸ’¸</div><div class="empty-title">No transactions yet</div></div>';
    return;
  }
  el.innerHTML = txns.map(t => txnItem(t, false)).join('');
}

function renderCashflowChart() {
  const canvas = document.getElementById('cashflowChart');
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.parentElement.clientWidth - 30;
  const H = 150;
  canvas.width  = W * dpr;
  canvas.height = H * dpr;
  canvas.style.width  = W+'px';
  canvas.style.height = H+'px';
  ctx.scale(dpr, dpr);

  // 6 months back
  const months = [];
  const [y,mo] = S.activeMonth.split('-').map(Number);
  for (let i=5; i>=0; i--) {
    const d = new Date(y, mo-1-i, 1);
    months.push(ymd(d.getFullYear(), d.getMonth()+1));
  }

  const inc  = months.map(m => actualIncome(m));
  const exp  = months.map(m => actualExpenses(m));
  const labs = months.map(m => monthName(m).split(' ')[0]);
  const maxV = Math.max(...inc, ...exp, 1);

  const pad  = { t:10, r:8, b:36, l:38 };
  const cW   = W - pad.l - pad.r;
  const cH   = H - pad.t - pad.b;
  const slot = cW / months.length;
  const bW   = slot * 0.28;
  const gap  = slot * 0.06;

  ctx.clearRect(0,0,W,H);

  // Grid
  for (let i=0; i<=4; i++) {
    const gy = pad.t + (cH/4)*i;
    ctx.strokeStyle = 'rgba(255,255,255,0.04)';
    ctx.lineWidth   = 1;
    ctx.beginPath(); ctx.moveTo(pad.l,gy); ctx.lineTo(W-pad.r,gy); ctx.stroke();
    if (i < 4) {
      ctx.fillStyle = 'rgba(255,255,255,0.18)';
      ctx.font = '8px JetBrains Mono';
      ctx.textAlign = 'right';
      ctx.fillText(fmt(maxV*(1-i/4)), pad.l-4, gy+3);
    }
  }

  months.forEach((m,i) => {
    const x = pad.l + slot*i + slot*0.08;
    const ih = (inc[i]/maxV)*cH;
    const eh = (exp[i]/maxV)*cH;

    // Income
    ctx.fillStyle = 'rgba(107,191,127,0.75)';
    ctx.beginPath();
    ctx.roundRect(x, pad.t+cH-ih, bW, Math.max(ih,1), [3,3,0,0]);
    ctx.fill();

    // Expense
    ctx.fillStyle = 'rgba(224,92,92,0.75)';
    ctx.beginPath();
    ctx.roundRect(x+bW+gap, pad.t+cH-eh, bW, Math.max(eh,1), [3,3,0,0]);
    ctx.fill();

    // Label
    ctx.fillStyle = 'rgba(255,255,255,0.3)';
    ctx.font = '9px Karla';
    ctx.textAlign = 'center';
    ctx.fillText(labs[i], x+bW+(gap/2), pad.t+cH+14);
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BUDGET PLANNER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBudget() {
  const m = S.activeMonth;
  const plan = getPlan(m);

  document.getElementById('budgetClosedBadge').innerHTML = plan.closed
    ? '<span class="closed-badge">âœ“ Closed</span>' : '';

  // Income
  const incEl = document.getElementById('incomeList');
  if (!plan.incomes.length) {
    incEl.innerHTML = '<div style="text-align:center;padding:10px;font-size:13px;color:var(--text-muted)">No income sources â€” tap + Add</div>';
  } else {
    incEl.innerHTML = plan.incomes.map(inc => `
      <div class="list-item">
        <div class="li-main">
          <div class="li-title">${inc.label}</div>
        </div>
        <div class="li-amount" style="color:var(--green)">${fmtF(inc.planned)}</div>
        <div class="li-actions">
          <button class="btn btn-ghost btn-xs" onclick="openIncomeModal('${inc.id}')">âœ</button>
          <button class="btn btn-ghost btn-xs" style="color:var(--red)" onclick="delIncome('${inc.id}')">âœ•</button>
        </div>
      </div>
    `).join('');
  }
  document.getElementById('totalPlannedIncome').textContent = fmtF(plannedIncome(m));

  // Categories
  const catEl = document.getElementById('catList');
  if (!plan.categories.length) {
    catEl.innerHTML = '<div style="text-align:center;padding:10px;font-size:13px;color:var(--text-muted)">No categories â€” tap + Add or apply templates</div>';
  } else {
    catEl.innerHTML = plan.categories.map(cat => {
      const actual = catActual(m, cat.name);
      const budget = cat.planned + (cat.carryIn||0);
      const pct    = budget>0 ? Math.min((actual/budget)*100,100) : 0;
      const color  = progressColor(pct);
      return `
        <div class="list-item" style="flex-wrap:wrap;align-items:flex-start">
          <div class="li-main" style="min-width:0;flex:unset;width:calc(100% - 70px)">
            <div style="display:flex;flex-wrap:wrap;align-items:center;gap:5px;margin-bottom:3px">
              <span class="li-title" style="white-space:normal">${cat.name}</span>
              <span class="tag tag-${cat.type}">${cat.type}</span>
              <span class="tag tag-${cat.priority}">${cat.priority}</span>
              ${cat.rollover?'<span class="tag tag-rollover">ğŸ”„</span>':''}
            </div>
            <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">
              ${fmtF(actual)} spent / ${fmtF(cat.planned)} planned
              ${cat.carryIn?` + ${fmtF(cat.carryIn)} carry-in`:''}
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width:${pct}%;background:${color}"></div>
            </div>
          </div>
          <div class="li-actions" style="flex-shrink:0">
            <button class="btn btn-ghost btn-xs" onclick="openCatModal('${cat.id}')">âœ</button>
            <button class="btn btn-ghost btn-xs" style="color:var(--red)" onclick="delCat('${cat.id}')">âœ•</button>
          </div>
        </div>
      `;
    }).join('');
  }
  document.getElementById('totalAllocated').textContent = fmtF(totalAllocated(m));

  // Savings contributions
  const scEl = document.getElementById('savingsContribList');
  if (!S.goals.length) {
    scEl.innerHTML = '<div style="font-size:13px;color:var(--text-muted);text-align:center;padding:8px">No goals yet â€” create them in Goals tab</div>';
  } else {
    scEl.innerHTML = S.goals.map(g => {
      const contrib = plan.savingsContributions[g.id] || 0;
      return `
        <div class="list-item">
          <div class="li-main">
            <div class="li-title">${g.name}</div>
            <div class="li-sub">${fmtF(g.saved)} / ${fmtF(g.target)}</div>
          </div>
          <input type="number" class="num-input" value="${contrib||''}" placeholder="0"
            onchange="updateContrib('${g.id}',this.value)">
        </div>
      `;
    }).join('');
  }

  // Plan summary
  const pInc   = plannedIncome(m);
  const alloc  = totalAllocated(m);
  const sav    = totalSavingsContrib(m);
  const buf    = plan.buffer||0;
  const rem    = pInc - alloc - sav - buf;
  document.getElementById('planSummary').innerHTML = `
    <div class="plan-row">
      <span class="plan-row-label">Total Planned Income</span>
      <span class="plan-row-val" style="color:var(--green)">${fmtF(pInc)}</span>
    </div>
    <div class="plan-row">
      <span class="plan-row-label">Category Allocations</span>
      <span class="plan-row-val">${fmtF(alloc)}</span>
    </div>
    <div class="plan-row">
      <span class="plan-row-label">Savings Contributions</span>
      <span class="plan-row-val">${fmtF(sav)}</span>
    </div>
    <div class="plan-row">
      <span class="plan-row-label">Buffer / Reserve</span>
      <span class="plan-row-val">${fmtF(buf)}</span>
    </div>
    <div class="plan-row">
      <span style="font-size:14px;font-weight:700;color:var(--text)">Remaining (Unallocated)</span>
      <span class="plan-row-val" style="color:${rem<0?'var(--red)':'var(--accent)'};font-size:15px">${fmtF(rem)}</span>
    </div>
  `;

  document.getElementById('bufferInput').value = buf || '';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INCOME CRUD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openIncomeModal(id) {
  const plan = getPlan(S.activeMonth);
  if (id) {
    const inc = plan.incomes.find(i=>i.id===id);
    document.getElementById('incomeMTitle').textContent = 'Edit Income';
    document.getElementById('i-label').value  = inc.label;
    document.getElementById('i-amount').value = inc.planned;
    document.getElementById('i-id').value     = id;
  } else {
    document.getElementById('incomeMTitle').textContent = 'Add Income';
    document.getElementById('i-label').value  = '';
    document.getElementById('i-amount').value = '';
    document.getElementById('i-id').value     = '';
  }
  openModal('m-income');
}

function saveIncome() {
  const label   = document.getElementById('i-label').value.trim();
  const planned = parseFloat(document.getElementById('i-amount').value)||0;
  const editId  = document.getElementById('i-id').value;
  if (!label) return;
  const plan = getPlan(S.activeMonth);
  if (editId) {
    const inc = plan.incomes.find(i=>i.id===editId);
    if (inc) { inc.label=label; inc.planned=planned; }
  } else {
    plan.incomes.push({ id:uid(), label, planned });
  }
  saveState(); closeModal('m-income'); renderBudget();
}

function delIncome(id) {
  const plan = getPlan(S.activeMonth);
  plan.incomes = plan.incomes.filter(i=>i.id!==id);
  saveState(); renderBudget();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CATEGORY CRUD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openCatModal(id) {
  const plan = getPlan(S.activeMonth);
  if (id) {
    const cat = plan.categories.find(c=>c.id===id);
    document.getElementById('catMTitle').textContent = 'Edit Category';
    document.getElementById('c-name').value      = cat.name;
    document.getElementById('c-type').value      = cat.type;
    document.getElementById('c-priority').value  = cat.priority;
    document.getElementById('c-planned').value   = cat.planned;
    document.getElementById('c-carryin').value   = cat.carryIn||0;
    document.getElementById('c-rollover').checked= cat.rollover||false;
    document.getElementById('c-id').value        = id;
  } else {
    document.getElementById('catMTitle').textContent = 'Add Category';
    document.getElementById('c-name').value      = '';
    document.getElementById('c-type').value      = 'variable';
    document.getElementById('c-priority').value  = 'should';
    document.getElementById('c-planned').value   = '';
    document.getElementById('c-carryin').value   = '';
    document.getElementById('c-rollover').checked= false;
    document.getElementById('c-id').value        = '';
  }
  openModal('m-cat');
}

function saveCat() {
  const name     = document.getElementById('c-name').value.trim();
  const type     = document.getElementById('c-type').value;
  const priority = document.getElementById('c-priority').value;
  const planned  = parseFloat(document.getElementById('c-planned').value)||0;
  const carryIn  = parseFloat(document.getElementById('c-carryin').value)||0;
  const rollover = document.getElementById('c-rollover').checked;
  const editId   = document.getElementById('c-id').value;
  if (!name) return;
  const plan = getPlan(S.activeMonth);
  if (editId) {
    const cat = plan.categories.find(c=>c.id===editId);
    if (cat) Object.assign(cat, {name,type,priority,planned,carryIn,rollover});
  } else {
    plan.categories.push({ id:uid(), name, type, priority, planned, carryIn, rollover });
  }
  saveState(); closeModal('m-cat'); renderBudget();
}

function delCat(id) {
  const plan = getPlan(S.activeMonth);
  plan.categories = plan.categories.filter(c=>c.id!==id);
  saveState(); renderBudget();
}

function updateContrib(goalId, val) {
  const plan = getPlan(S.activeMonth);
  plan.savingsContributions[goalId] = parseFloat(val)||0;
  saveState(); renderBudget();
}

function saveBuffer() {
  const plan = getPlan(S.activeMonth);
  plan.buffer = parseFloat(document.getElementById('bufferInput').value)||0;
  saveState(); renderBudget();
}

function autoBalance() {
  const m = S.activeMonth;
  const plan = getPlan(m);
  const rem = plannedIncome(m) - totalAllocated(m) - totalSavingsContrib(m);
  plan.buffer = Math.max(0, rem);
  document.getElementById('bufferInput').value = plan.buffer;
  saveState(); renderBudget();
}

// Copy prev / apply templates
function copyPreviousMonth() {
  const [y,mo] = S.activeMonth.split('-').map(Number);
  const d = new Date(y,mo-2,1);
  const prevKey = ymd(d.getFullYear(), d.getMonth()+1);
  const prev = S.months[prevKey];
  if (!prev) { alert('No previous month plan found.'); return; }
  const plan = getPlan(S.activeMonth);
  plan.incomes    = prev.incomes.map(i=>({...i,id:uid()}));
  plan.categories = prev.categories.map(c=>({...c,id:uid(),carryIn:0}));
  plan.buffer     = prev.buffer||0;
  plan.savingsContributions = {...(prev.savingsContributions||{})};
  saveState(); renderBudget();
}

function applyTemplates() {
  if (!S.templates.length) { alert('No templates found. Create some in the Templates tab.'); return; }
  const plan = getPlan(S.activeMonth);
  S.templates.forEach(t => {
    if (!plan.categories.find(c=>c.name===t.name)) {
      plan.categories.push({ id:uid(), name:t.name, type:t.type, priority:t.priority, planned:t.amount, carryIn:0, rollover:t.rollover });
    }
  });
  saveState(); renderBudget();
}

// Close month
function showCloseModal() {
  const m = S.activeMonth;
  const plan = getPlan(m);
  const rollCats = plan.categories.filter(c=>c.rollover);
  const el = document.getElementById('rolloverPreview');
  if (!rollCats.length) {
    el.innerHTML = '<div style="font-size:13px;color:var(--text-muted);padding:8px 0">No rollover categories found.</div>';
  } else {
    el.innerHTML = `
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Rollover Preview</div>
      ${rollCats.map(cat => {
        const actual   = catActual(m, cat.name);
        const leftover = cat.planned + (cat.carryIn||0) - actual;
        return `
          <div class="list-item">
            <div class="li-main"><div class="li-title">${cat.name}</div></div>
            <span style="font-family:var(--mono);font-size:14px;color:${leftover>=0?'var(--green)':'var(--red)'}">
              ${leftover>=0?'+':''}${fmtF(leftover)}
            </span>
          </div>
        `;
      }).join('')}
    `;
  }
  openModal('m-close');
}

function closeMonth() {
  const m = S.activeMonth;
  const plan = getPlan(m);
  plan.closed = true;

  const [y,mo] = m.split('-').map(Number);
  const nextD  = new Date(y,mo,1);
  const nextKey= ymd(nextD.getFullYear(), nextD.getMonth()+1);
  const next   = getPlan(nextKey);

  plan.categories.filter(c=>c.rollover).forEach(cat => {
    const actual   = catActual(m, cat.name);
    const leftover = cat.planned + (cat.carryIn||0) - actual;
    let nc = next.categories.find(c=>c.name===cat.name);
    if (!nc) {
      nc = { id:uid(), name:cat.name, type:cat.type, priority:cat.priority, planned:cat.planned, carryIn:0, rollover:true };
      next.categories.push(nc);
    }
    nc.carryIn = (nc.carryIn||0) + leftover;
  });

  saveState(); closeModal('m-close'); renderBudget();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TRANSACTIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTransactions() {
  const m = S.activeMonth;
  let txns = monthTxns(m);
  if (txnFilter !== 'all') txns = txns.filter(t=>t.type===txnFilter);
  const q = (document.getElementById('txnSearch').value||'').toLowerCase();
  if (q) txns = txns.filter(t =>
    t.description.toLowerCase().includes(q) ||
    (t.category||'').toLowerCase().includes(q) ||
    (t.note||'').toLowerCase().includes(q)
  );
  txns.sort((a,b)=>new Date(b.date)-new Date(a.date));

  const el = document.getElementById('txnList');
  if (!txns.length) {
    el.innerHTML = '<div class="empty"><div class="empty-emoji">ğŸ“‹</div><div class="empty-title">No transactions</div><div class="empty-sub">Tap + to add one</div></div>';
    return;
  }

  // Group by date
  const groups = {};
  txns.forEach(t => { if (!groups[t.date]) groups[t.date]=[]; groups[t.date].push(t); });

  el.innerHTML = Object.entries(groups)
    .sort((a,b)=>b[0].localeCompare(a[0]))
    .map(([date,ts]) => {
      const d = new Date(date+'T12:00:00');
      const label = d.toLocaleDateString('en-IE',{weekday:'short',month:'short',day:'numeric'});
      const dayTotal = ts.reduce((s,t)=>s+(t.type==='income'?t.amount:-t.amount),0);
      return `
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 2px 3px">
            <span class="date-group-header" style="padding:0">${label}</span>
            <span style="font-family:var(--mono);font-size:11px;color:${dayTotal>=0?'var(--green)':'var(--red)'}">
              ${dayTotal>=0?'+':''}${fmtF(dayTotal)}
            </span>
          </div>
          <div class="card" style="padding:6px 12px;margin-bottom:6px">
            ${ts.map(t=>txnItem(t,true)).join('')}
          </div>
        </div>
      `;
    }).join('');
}

function txnItem(t, actions=false) {
  const emoji = t.type==='income' ? 'ğŸ’š' : catEmoji(t.category);
  return `
    <div class="list-item">
      <div class="li-icon" style="background:${t.type==='income'?'var(--green-dim)':'var(--elevated)'}">
        ${emoji}
      </div>
      <div class="li-main">
        <div class="li-title">${t.description}</div>
        <div class="li-sub">${t.category||'â€”'}${t.note?' Â· '+t.note:''}</div>
      </div>
      <div class="li-amount" style="color:${t.type==='income'?'var(--green)':'var(--red)'}">
        ${t.type==='income'?'+':'âˆ’'}${fmtF(t.amount)}
      </div>
      ${actions?`
        <div class="li-actions">
          <button class="btn btn-ghost btn-xs" onclick="openTxnModal('${t.id}')">âœ</button>
          <button class="btn btn-ghost btn-xs" style="color:var(--red)" onclick="delTxn('${t.id}')">âœ•</button>
        </div>
      `:''}
    </div>
  `;
}

function setTxnFilter(f, btn) {
  txnFilter = f;
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderTransactions();
}

function openTxnModal(id) {
  const plan = getPlan(S.activeMonth);
  const allCats = [...new Set([
    ...plan.categories.map(c=>c.name),
    ...S.transactions.map(t=>t.category).filter(Boolean),
    ...S.templates.map(t=>t.name)
  ])].sort();

  document.getElementById('t-cat').innerHTML =
    '<option value="">â€” Select â€”</option>' +
    allCats.map(c=>`<option value="${c}">${c}</option>`).join('');

  if (id) {
    const t = S.transactions.find(t=>t.id===id);
    document.getElementById('txnMTitle').textContent = 'Edit Transaction';
    document.getElementById('t-type').value   = t.type;
    document.getElementById('t-date').value   = t.date;
    document.getElementById('t-desc').value   = t.description;
    document.getElementById('t-amount').value = t.amount;
    document.getElementById('t-cat').value    = t.category||'';
    document.getElementById('t-note').value   = t.note||'';
    document.getElementById('t-id').value     = id;
  } else {
    document.getElementById('txnMTitle').textContent = 'Add Transaction';
    document.getElementById('t-type').value   = 'expense';
    document.getElementById('t-date').value   = new Date().toISOString().split('T')[0];
    document.getElementById('t-desc').value   = '';
    document.getElementById('t-amount').value = '';
    document.getElementById('t-cat').value    = '';
    document.getElementById('t-note').value   = '';
    document.getElementById('t-id').value     = '';
  }
  openModal('m-txn');
}

function saveTxn() {
  const type        = document.getElementById('t-type').value;
  const description = document.getElementById('t-desc').value.trim();
  const amount      = parseFloat(document.getElementById('t-amount').value)||0;
  const date        = document.getElementById('t-date').value;
  const category    = document.getElementById('t-cat').value;
  const note        = document.getElementById('t-note').value.trim();
  const editId      = document.getElementById('t-id').value;
  if (!description || !amount || !date) return;
  const d = new Date(date+'T12:00:00');
  const month = ymd(d.getFullYear(), d.getMonth()+1);
  if (editId) {
    const t = S.transactions.find(t=>t.id===editId);
    if (t) Object.assign(t, {type,description,amount,date,category,note,month});
  } else {
    S.transactions.push({ id:uid(), type, description, amount, date, category, note, month });
  }
  saveState(); closeModal('m-txn'); renderTransactions();
}

function delTxn(id) {
  S.transactions = S.transactions.filter(t=>t.id!==id);
  saveState(); renderTransactions();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TEMPLATES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTemplates() {
  const el = document.getElementById('templateList');
  if (!S.templates.length) {
    el.innerHTML = '<div class="empty"><div class="empty-emoji">ğŸ“‹</div><div class="empty-title">No templates yet</div><div class="empty-sub">Create reusable budget categories</div></div>';
    return;
  }
  el.innerHTML = S.templates.map(t => `
    <div class="tmpl-card">
      <div style="flex:1;min-width:0">
        <div style="font-size:15px;font-weight:600;color:var(--text);margin-bottom:7px">${t.name}</div>
        <div style="display:flex;flex-wrap:wrap;gap:5px">
          <span class="tag tag-${t.type}">${t.type}</span>
          <span class="tag tag-${t.priority}">${t.priority}</span>
          ${t.rollover?'<span class="tag tag-rollover">ğŸ”„ rollover</span>':''}
        </div>
      </div>
      <div style="text-align:right;flex-shrink:0">
        <div class="li-amount" style="margin-bottom:8px">${fmtF(t.amount)}<span style="font-size:11px;color:var(--text-muted);font-family:'Karla',sans-serif">/mo</span></div>
        <div style="display:flex;gap:5px">
          <button class="btn btn-secondary btn-xs" onclick="openTmplModal('${t.id}')">âœ</button>
          <button class="btn btn-danger btn-xs" onclick="delTmpl('${t.id}')">âœ•</button>
        </div>
      </div>
    </div>
  `).join('');
}

function openTmplModal(id) {
  if (id) {
    const t = S.templates.find(t=>t.id===id);
    document.getElementById('tmplMTitle').textContent  = 'Edit Template';
    document.getElementById('tm-name').value      = t.name;
    document.getElementById('tm-type').value      = t.type;
    document.getElementById('tm-priority').value  = t.priority;
    document.getElementById('tm-amount').value    = t.amount;
    document.getElementById('tm-rollover').checked= t.rollover||false;
    document.getElementById('tm-id').value        = id;
  } else {
    document.getElementById('tmplMTitle').textContent  = 'Add Template';
    document.getElementById('tm-name').value      = '';
    document.getElementById('tm-type').value      = 'variable';
    document.getElementById('tm-priority').value  = 'should';
    document.getElementById('tm-amount').value    = '';
    document.getElementById('tm-rollover').checked= false;
    document.getElementById('tm-id').value        = '';
  }
  openModal('m-tmpl');
}

function saveTmpl() {
  const name     = document.getElementById('tm-name').value.trim();
  const type     = document.getElementById('tm-type').value;
  const priority = document.getElementById('tm-priority').value;
  const amount   = parseFloat(document.getElementById('tm-amount').value)||0;
  const rollover = document.getElementById('tm-rollover').checked;
  const editId   = document.getElementById('tm-id').value;
  if (!name) return;
  if (editId) {
    const t = S.templates.find(t=>t.id===editId);
    if (t) Object.assign(t, {name,type,priority,amount,rollover});
  } else {
    S.templates.push({ id:uid(), name, type, priority, amount, rollover });
  }
  saveState(); closeModal('m-tmpl'); renderTemplates();
}

function delTmpl(id) {
  S.templates = S.templates.filter(t=>t.id!==id);
  saveState(); renderTemplates();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SAVINGS GOALS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGoals() {
  const el = document.getElementById('goalList');
  if (!S.goals.length) {
    el.innerHTML = '<div class="empty"><div class="empty-emoji">ğŸ¯</div><div class="empty-title">No goals yet</div><div class="empty-sub">Set targets to track your savings</div></div>';
    return;
  }
  el.innerHTML = S.goals.map(g => {
    const pct  = g.target>0 ? Math.min((g.saved/g.target)*100,100) : 0;
    const rem  = g.target - g.saved;
    const m    = S.activeMonth;
    const co   = (getPlan(m).savingsContributions[g.id]||0);
    const mos  = (co>0 && rem>0) ? Math.ceil(rem/co) : null;
    const done = pct >= 100;

    let deadline = '';
    if (g.deadline) {
      const d = new Date(g.deadline+'-01');
      deadline = ` Â· Deadline: ${d.toLocaleDateString('en-IE',{month:'short',year:'numeric'})}`;
    }

    return `
      <div class="goal-card ${done?'complete':''}">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
          <div>
            <div style="font-family:'Playfair Display',serif;font-size:17px;font-weight:600;color:var(--text)">${g.name}</div>
            ${deadline?`<div style="font-size:11px;color:var(--text-muted);margin-top:2px">${deadline}</div>`:''}
          </div>
          <div style="display:flex;gap:4px">
            <button class="btn btn-ghost btn-xs" onclick="openGoalModal('${g.id}')">âœ</button>
            <button class="btn btn-ghost btn-xs" style="color:var(--red)" onclick="delGoal('${g.id}')">âœ•</button>
          </div>
        </div>

        <div style="display:flex;justify-content:space-between;margin-bottom:10px">
          <div>
            <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">Saved</div>
            <div style="font-family:var(--mono);font-size:20px;color:var(--green)">${fmtF(g.saved)}</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">Target</div>
            <div style="font-family:var(--mono);font-size:20px;color:var(--accent)">${fmtF(g.target)}</div>
          </div>
        </div>

        <div class="progress-bar" style="height:8px;margin-bottom:6px">
          <div class="progress-fill" style="width:${pct}%;background:${done?'linear-gradient(90deg,var(--accent),var(--green))':'var(--accent)'}"></div>
        </div>

        <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-muted);margin-bottom:${done?0:10}px">
          <span>${pct.toFixed(1)}% complete</span>
          <span>${done?'ğŸ‰ Goal achieved!':'Remaining: '+fmtF(rem)}</span>
        </div>

        ${!done ? `
          ${mos ? `<div style="font-size:12px;color:var(--blue);margin-bottom:8px">â‰ˆ ${mos} month${mos>1?'s':''} at ${fmtF(co)}/mo contributions</div>` : ''}
          <div class="divider"></div>
          <div style="display:flex;align-items:center;gap:8px">
            <div style="flex:1">
              <div style="font-size:11px;color:var(--text-muted);margin-bottom:5px">Update saved amount</div>
              <input type="number" class="form-input" value="${g.saved}" id="gs_${g.id}" style="padding:8px 10px;font-size:14px">
            </div>
            <button class="btn btn-success btn-sm" style="align-self:flex-end" onclick="updateGoalSaved('${g.id}')">Save</button>
          </div>
        ` : ''}
      </div>
    `;
  }).join('');
}

function openGoalModal(id) {
  if (id) {
    const g = S.goals.find(g=>g.id===id);
    document.getElementById('goalMTitle').textContent = 'Edit Goal';
    document.getElementById('g-name').value    = g.name;
    document.getElementById('g-target').value  = g.target;
    document.getElementById('g-saved').value   = g.saved;
    document.getElementById('g-deadline').value= g.deadline||'';
    document.getElementById('g-id').value      = id;
  } else {
    document.getElementById('goalMTitle').textContent = 'Add Goal';
    document.getElementById('g-name').value    = '';
    document.getElementById('g-target').value  = '';
    document.getElementById('g-saved').value   = '';
    document.getElementById('g-deadline').value= '';
    document.getElementById('g-id').value      = '';
  }
  openModal('m-goal');
}

function saveGoal() {
  const name     = document.getElementById('g-name').value.trim();
  const target   = parseFloat(document.getElementById('g-target').value)||0;
  const saved    = parseFloat(document.getElementById('g-saved').value)||0;
  const deadline = document.getElementById('g-deadline').value;
  const editId   = document.getElementById('g-id').value;
  if (!name) return;
  if (editId) {
    const g = S.goals.find(g=>g.id===editId);
    if (g) Object.assign(g, {name,target,saved,deadline});
  } else {
    S.goals.push({ id:uid(), name, target, saved, deadline });
  }
  saveState(); closeModal('m-goal'); renderGoals();
}

function delGoal(id) {
  S.goals = S.goals.filter(g=>g.id!==id);
  Object.values(S.months).forEach(m => {
    if (m.savingsContributions) delete m.savingsContributions[id];
  });
  saveState(); renderGoals();
}

function updateGoalSaved(id) {
  const val = parseFloat((document.getElementById('gs_'+id)||{}).value)||0;
  const g = S.goals.find(g=>g.id===id);
  if (g) { g.saved=val; saveState(); renderGoals(); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MODAL HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

document.querySelectorAll('.modal-overlay').forEach(ov => {
  ov.addEventListener('click', e => { if (e.target===ov) ov.classList.remove('open'); });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('prevMonth').addEventListener('click', prevMonth);
document.getElementById('nextMonth').addEventListener('click', nextMonth);

// Handle window resize for chart
let resizeTimer;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => { if (currentPage==='dashboard') renderCashflowChart(); }, 200);
});

loadState();
updateHeader();
renderDashboard();
</script>
</body>
</html>
